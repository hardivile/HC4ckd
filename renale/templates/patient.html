{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Patients - AI4CKD</title>
    <link rel="stylesheet" href="{% static 'patient.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap.min.css' %}">
    <script src="{% static 'bootstrap.bundle.min.js' %}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@^1.16.0/dist/pdf-lib.min.js"></script>
    <script src="../auto-tasks.js" defer></script>
    <script src="patient.js" defer></script>
</head>
<body>
    <div class="sidebar" role="navigation">
        <h1>AI4CKD</h1>
        <ul>
            <li><a href="{% url 'dm' %}" aria-current="page">üìä Tableau de bord</a></li>
            <li><a href="{% url 'pat' %}">üë• Patients</a></li>
            <li><a href="{% url 'rend' %}">üóì Rendez-vous</a></li>
            <li><a href="{% url 'par' %}">‚öôÔ∏è Param√®tres</a></li>
        </ul>
        <div class="sidebar-footer">
            <form action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button id="logoutBtn" aria-label="D√©connexion">
                    üö™ D√©connexion
                </button>
            </form>
        </div>
    </div>

    <div class="main-content">
        <header>
            <div class="container">
                <form method="get" class="d-flex" role="search">
                    <input class="form-control me-2" type="search" name="patient" placeholder=" üîç Rechercher un patient..." aria-label="Rechercher un patient">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>

            <div class="profile">üë®‚öïÔ∏è Dr. Dupont</div>
        </header>

        <section class="patient-management">
            <div class="section-header">
                <h2>Gestion des Patients</h2>
                <button id="generateAllPdf" class="pdf-btn">üìÑ Exporter tous les PDF</button>
            </div>

            <div class="form-container">
                <h3>Ajouter un nouveau patient</h3>
                <form action="{% url 'addp' %}" id="patientForm" method="post">
                    {% csrf_token %}
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="lastName">Nom:</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="firstName">Pr√©nom:</label>
                            <input type="text" id="firstName" name="firstName">
                        </div>
                        
                        <div class="form-group">
                            <label for="age">√Çge:</label>
                            <input type="number" id="age" name="age" min="0" max="120">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email">
                        </div>

                        <div class="form-group">
                            <label for="ckdStage">Stade MRC:</label>
                            <select id="ckdStage" name="ckdStage" required>
                                <option value="">S√©lectionner...</option>
                                <option value="1">Stade 1</option>
                                <option value="2">Stade 2</option>
                                <option value="3">Stade 3</option>
                                <option value="4">Stade 4</option>
                                <option value="5">Stade 5</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="lastExam">Dernier examen:</label>
                            <input type="date" id="lastExam" name="lastExam" required>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Enregistrer</button>
                        <button type="reset" class="cancel-btn">Annuler</button>
                    </div>
                </form>
            </div>

            <div class="patient-list">
                <h3>Liste des Patients</h3>
                <div class="table-responsive">
                    <table aria-label="Liste des patients">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Pr√©nom</th>
                                <th>√Çge</th>
                                <th>Stade MRC</th>
                                <th>Dernier Examen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientList">
                            {% for a in pt %}
                                <tr>
                                    <td>{{ a.nom }}</td>
                                    <td>{{ a.prenoms }}</td>
                                    <td>{{ a.age }}</td>
                                    <td>{{ a.stade }}</td>
                                    <td>{{ a.date|date:"d/m/Y" }}</td>  

                                    <td>
                                        <a href="update/{{ a.id }}">
                                            <button class="btn btn-warning btn-sm">Modifier</button>
                                        </a>

                                        <button class="btn btn-danger btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#confirmDeleteModal"
                                                data-id="{{ a.id }}">
                                            Supprimer
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Modale de confirmation -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    √ätes-vous s√ªr de vouloir supprimer ce patient ?
                </div>
                <div class="modal-footer">
                    <!-- Formulaire pour la suppression -->
                    <form id="deleteForm" method="POST" action="">
                        {% csrf_token %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Non</button>
                        <button type="submit" class="btn btn-danger">Oui, supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript pour afficher la modal apr√®s la suppression
        document.addEventListener('DOMContentLoaded', function () {
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;  // Bouton qui a d√©clench√© la modal
                var id = button.getAttribute('data-id');  // ID du patient
                var form = confirmDeleteModal.querySelector('#deleteForm');
                form.action = "{% url 'SupP' 0 %}".replace('0', id);  // Remplacer l'ID dans l'action
            });
        });
    </script>
</body>
</html>
